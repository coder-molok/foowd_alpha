<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="ROBOTS" content="NOINDEX, NOFOLLOW">

  <!--#set var="page" value="Landing" --> 
  <!--#set var="page_desc" value="Pagina di accesso" --> 
  <title>f oo w d  - in progress - <!--#echo var="page" --></title>

  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/foowd.css">

  <script src="js/lib/getParams.js"></script>
  <script type="text/javascript">
    accessHash=par.hash;
    par.uriHash=encodeURIComponent(par.hash);
    debug=3;
  </script>
  <script type="text/javascript" src="js/lib/ajax.js"></script>
  <script type="text/javascript" src="js/lib/switch.js"></script>
  <script type="text/javascript" src="js/lib/due.js"></script>
  <script type="text/javascript" src="js/lib/hash.js"></script>
  <script type="text/javascript" src="js/foowd_generics.js"></script>
  <script type="text/javascript" src="js/access.js"></script>
  <script type="text/javascript" src="js/carrello.js"></script>
  <script type="text/javascript" src="prodotti/prodotti.js"></script>
  <script>
  var carrello = new Carrello(prodotti);
  carrello.init();

  function foreach(coll, func) {
    for (var i=0; i<coll.length; i++) {
      func(coll[i]);
    }
  }

  function leggiCarrello(esito) {
    switch((esito+":").split(":")[0]) {
    case "ok":
      foreach(document.getElementsByClassName('ordineOk'),
          function (el) { if (typeof el == 'object') { el.style.display="block";}});
      break;
    case "error":
      foowd_alerts("Attenzione, il seguente errore è avvenuto durante il caricamento dell'ordine attuale: "+
          ((esito+":").split(":")[1])+". Contattaci per segnalare il problema.");
    case "unexpected":
      foowd_alerts("Attenzione, un errore inatteso al caricamento dell'ordine. Contattaci per segnalare il problema.");
      break;
    case "ko":
      foreach(document.getElementsByClassName('ordineKo'),
          function (el) { if (typeof el == 'object') { el.style.display="block";}});
      foowd_alerts("Attenzione, un errore inatteso durante il caricamento dell'ordine. Contattaci per segnalare il problema.");
      break;
    default:
      // unknown, ...
      foowd_alerts("Attenzione, un errore sconosciuto al caricamento dell'ordine. Contattaci per segnalare il problema.");
    }
  }

  function salvadati() {
    if ('primoAccesso' in par) {
      var salva = new Ajax(2);
      salva.open('POST', foowd.dbhost+'registr.php', false);
      salva.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      salva.setRequestHeader('Accept','application/json')
      salva.onsuccess = function (rText) {
        var resp=null;
        try {
          resp=JSON.parse(rText);
        } catch (exc) {
          foowd_alerts("Attenzione, un errore inatteso al salvataggio dei tuoi dati. Contattaci per segnalare il problema.");
          return;
        }
        if ('FoowdService' in resp && resp.FoowdService=='v1.0') {
          if (resp.status=="ok") {
            foowd_alerts("I tuoi dati sono stati salvati correttamente.");
          } else if (resp.errors.trim().length>0) {
            foowd_alerts("Attenzione, il seguente errore è avvenuto durante il salvataggio dei tuoi dati ("+resp.email+"): "+resp.errors+". Contattaci per segnalare il problema.");
          } else {
            foowd_alerts("Attenzione, un errore inatteso al salvataggio dei tuoi dati. Contattaci per segnalare il problema.");
          }
        } else {
          console.log("Landing - data saving - Response is not a valid FoowdService v1.0 result.");
          foowd_alerts("Attenzione, un errore inatteso al salvataggio dei tuoi dati. Contattaci per segnalare il problema.");
        }
      }
      salva.onfail = function (err) {
        foowd_alerts("Attenzione, un errore inatteso durante il salvataggio dei tuoi dati. Contattaci per segnalare il problema.");
      }

      // devo salvare tutti i dati anagrafici
      var dat="hash="+par.hash;
      dat+="&email="+par.email;
      dat+="&user="+par.user;
      dat+="&nome="+par.nome;
      dat+="&cognome="+par.cognome;
      dat+="&telefono="+par.telefono;
      if ('grphd' in par) {
        dat+="&indirizzo="+par.indirizzo;
        dat+="&nciv="+par.nciv;
        dat+="&comune="+par.comune;
        dat+="&cap="+par.cap;
        dat+="&provincia="+par.provincia;
      }
      salva.send(dat);
    } else {
      // a dispetto del nome di funzione, carico i dati
      if (!access.lock) {
        var leggi=new Ajax(2);
        leggi.open('POST', foowd.dbhost+'load.php', false);
        leggi.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        leggi.setRequestHeader('Accept','application/json')
        leggi.onsuccess = function (rText) {
          var resp=null;
          try {
            resp=JSON.parse(rText);
          } catch (exc) {
            foowd_alerts("Attenzione, un errore inatteso alla lettura dei tuoi dati. Contattaci per segnalare il problema.");
            return;
          }
          if ('FoowdService' in resp && resp.FoowdService=='v1.0') {
            if (resp.status=="ok") {
              par.user=resp.user;
              par.email=resp.email;
            } else if (resp.errors.trim().length>0) {
              foowd_alerts("Attenzione, il seguente errore è avvenuto durante la lettura dei tuoi dati ("+resp.email+"): "+resp.errors+". Contattaci per segnalare il problema.");
            } else {
              foowd_alerts("Attenzione, un errore inatteso alla lettura dei tuoi dati. Contattaci per segnalare il problema.");
            }
          } else {
            console.log("Landing - data loading - Response is not a valid FoowdService v1.0 result.");
            foowd_alerts("Attenzione, un errore inatteso alla lettura dei tuoi dati. Contattaci per segnalare il problema.");
          }
        }
        leggi.onfail = function (err) {
          foowd_alerts("Attenzione, un errore inatteso durante la lettura dei tuoi dati. Contattaci per segnalare il problema.");
        }
        
        leggi.send("hash="+par.hash);
      }
    }
    
    init();
  }
  
  function init() {
    // pezza anti sdoppiamento waiting-silk
    document.body.removeChild(waitingSilk);
    replacePar(document.body, '!blank');
    // pezza anti sdoppiamento waiting-silk
    document.body.appendChild(waitingSilk);
    
    // apro la waiting-silk
    

    // carico i dati di eventuale ordine pendente
    carrello.fromDB(par, leggiCarrello).send();
    
    function preparaDati() {
      var dati="?email={email}&user={user}&hash={hash}&prv=landing&cart={cart}".
          replace("{email}",par.email).
          replace("{user}",par.user).
          replace("{hash}",par.uriHash).
          replace("{cart}",carrello.toPar());
      this['search']=dati;
    }

    // carico i dati di eventuali ordini di gruppo
    
    // mostro la situazione
    
    // aggiungo l'onclick ai link 
    document.getElementById("ordlink").addEventListener('mousedown', preparaDati);

    // chiudo la w-s
  }
  
  function preparaDati() {
    var dati="?not-def";
    this['search']=dati;
  }

  //** si arriva da mail con codice di registrazione
  function primoAccesso() {
    setTimeout(salvadati,100);
    var toHide=[];
    if ('primoAccesso' in par) {
  	  toHide = document.body.getElementsByClassName('bentornato');
    } else {
  	  toHide = document.body.getElementsByClassName('benvenuto');
    }
    for (var i=0; i<toHide.length; i++) {
      var th=toHide[i];
      if (!th.style) th.style=new CSSStyleDeclaration();
      th.style.display='none';
    }

  }
  </script>
</head>
<body onload="primoAccesso();">
<!--#include virtual="header_foowd.shtml" -->

  <h4>Ciao {user}</h4>
  <h3 class="benvenuto">Benvenuto sulla piattaforma per l'acquisto intelligente</h3>
  <h3 class="bentornato">Bentornato sulla piattaforma per l'acquisto a filiera corta</h3>
  <p class="istruzioni">Da questa pagina puoi accedere alle funzionalità del sito.</p>
  <a href="catalog.shtml?email={email}&user={user}&hash={uriHash}" >Catalogo</a>
  <br/>
  <a href="revubuy.shtml" id="ordlink">Ordine in corso</a>
  <br/>
  <a href="ggroup.shtml?email={email}&user={user}&hash={uriHash}" class="accessControl">Gestione Gruppo</a>

<!--#include virtual="footer_foowd.shtml" -->
</body>
</html>
