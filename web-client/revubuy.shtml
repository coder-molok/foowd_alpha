<!doctype html>
<html lang="it">
<head>
	<meta charset="UTF-8">
  <meta name="ROBOTS" content="NOINDEX, NOFOLLOW">

  <!--#set var="page" value="Verifica" --> 
  <!--#set var="page_desc" value="Carrello della spesa" --> 
	<title>f oo w d  - in progress - <!--#echo var="page" --></title>

  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/foowd.css">

  <script type="text/javascript" src="js/lib/getParams.js"></script>
  <script type="text/javascript">
    accessHash=par.hash;
    par.uriHash=encodeURIComponent(par.hash);
    debug=3;
  </script>
  <script type="text/javascript" src="js/lib/ajax.js"></script>
  <script type="text/javascript" src="js/lib/hash.js"></script>
  <script type="text/javascript" src="js/foowd_generics.js"></script>
  <script type="text/javascript" src="js/access.js"></script>
  <script type="text/javascript" src="js/carrello.js"></script>
	<script type="text/javascript" src="prodotti/prodotti.js"></script>
  <script type="text/javascript">
	
  waitingSilk.neededOnLoad=0; // resta il velo finch'è non ho l'esito del salvataggio

  var carrello = new Carrello(prodotti);
  if ("cart" in par) {
    carrello.fromPar(par.cart);
  }

  function foreach(coll, func) {
    for (var i=0; i<coll.length; i++) {
      func(coll[i]);
    }
  }

  function salvaCarrello(esito) {
    switch((esito+":").split(":")[0]) {
    case "ok":
      foowd_messgs("Il tuo ordine è stato salvato correttamente.");
      foreach(document.getElementsByClassName('ordineOk'),
          function (el) { if (typeof el == 'object') { el.style.display="block";}});
      break;
    case "error":
      foowd_alerts("Attenzione, il seguente errore è avvenuto durante il salvataggio dell'ordine: "+
          ((esito+":").split(":")[1])+". Contattaci per segnalare il problema.");
    case "unexpected":
      foowd_alerts("Attenzione, un errore inatteso al salvataggio dell'ordine. Contattaci per segnalare il problema.");
      break;
    case "ko":
      foreach(document.getElementsByClassName('ordineKo'),
          function (el) { if (typeof el == 'object') { el.style.display="block";}});
      foowd_alerts("Attenzione, un errore inatteso durante il salvataggio dell'ordine. Contattaci per segnalare il problema.");
      break;
    default:
      // unknown, ...
      foowd_alerts("Attenzione, un errore sconosciuto al salvataggio dell'ordine. Contattaci per segnalare il problema.");
    }
    waitingSilk.hide();
  }

  function impaginaCarrello() {
    var cr=document.getElementById('prodotti');
    var i,tot=0,prd;

    // scrivo l'elenco prodotti e totale
    while (cr.firstChild.rows.length>0) cr.firstChild.deleteRow(-1);
    for (i=0; i<carrello.prodotti(); i++) {
      cr.firstChild.insertRow(i);
      prd=carrello.completa(i);
      if (prd.qta==0) continue; // salto i prodotti rimossi
      cr.firstChild.rows[i].insertCell(0).innerHTML=prd.prodotto;
      cr.firstChild.rows[i].insertCell(1).innerHTML=prd.porzione;
      cr.firstChild.rows[i].insertCell(2).innerHTML=prd.qta+" x";
      cr.firstChild.rows[i].insertCell(3).innerHTML=euro(prd.prezzo);
      cr.firstChild.rows[i].phash=prd.hash;
      tot+=prd.prezzo*prd.qta;
    }
    cr.firstChild.insertRow(i);
    cr.firstChild.rows[i].insertCell(0).innerHTML=(i==0?"<i>Carrello vuoto</i>":"<b>totale</b>");
    cr.firstChild.rows[i].insertCell(1);
    cr.firstChild.rows[i].insertCell(2);
    cr.firstChild.rows[i].insertCell(3).innerHTML=(i==0?"":euro(tot));
    cr.style.display='';
  }

  function preparaDati() {
    var dati="?email={email}&user={user}&hash={hash}&cart={cart}".
        replace("{email}",par.email).
        replace("{user}",par.user).
        replace("{hash}",par.uriHash).
        replace("{cart}",carrello.toPar());
    this['search']=dati;
  }
  function init() {
    var cr, chiudiWs=false;
    // pezza anti sdoppiamento waiting-silk
    document.body.removeChild(waitingSilk);
    replacePar(document.body, true);
    // pezza anti sdoppiamento waiting-silk
    document.body.appendChild(waitingSilk);
    //!! replace par ha un baco: resetta tutto il DOM ricreando ogni oggetto, 
    //!! quindi scrivere tutte le manipolazioni del DOM qui sotto!!

    waitingSilk.show();
    foreach(document.getElementsByClassName('ordineOk'),
        function (el) { if (typeof el == 'object') { el.style.display="none";}});
    foreach(document.getElementsByClassName('ordineKo'),
        function (el) { if (typeof el == 'object') { el.style.display="none";}});

    carrello.init();
    //foreach(carrello.selezioni, function (el, i) {
    //  carrello.completa(i);
    //  console.log(el.hash+":"+el.prodotto+" "+el.porzione+" "+el.qta);
    //});


    // salvo i dati del carrello se arrivo da catalogo
    if ('prv' in par && par.prv=='catalog') {
      var salva = carrello.toDB(par, salvaCarrello);
      salva.send(salva.postData);
    } else {
      chiudiWs=true;
    }

    // preparo il car-review
    cr=document.getElementById('prodotti');
    cr.appendChild(document.createElement('table'));
    impaginaCarrello();
    
    // aggiungo l'onclick ai link 
    document.getElementById("conflink").addEventListener('mousedown', preparaDati);
    document.getElementById("catlink").addEventListener('mousedown', preparaDati);
    document.getElementById("lanlink").addEventListener('mousedown', preparaDati);
    
    if (chiudiWs) waitingSilk.hide();
  }
  </script>
</head>
<body onload="init()">
<!--#include virtual="header_foowd.shtml" -->

  <h1>Prodotti attualmente selezionati</h1>
  <p class="istruzioni">In questa pagina puoi controllare la tua selezione di prodotti inserita.</p>

  <p class="istruzioni ordineKo bold">Attenzione! un problema tecnico ha impedito la registrazione del tuo ordine.</p>
  <p class="istruzioni ordineKo">Ci scusiamo per il disagio.</p>
  <p class="istruzioni ordineKo">Puoi provare a ripetere l'operazione tornando al Catalogo, ma se hai già riprovato puoi contattarci via mail per segnalare l'ordine fallito ed il problema</p>
  <form action="mailto:foowd.info@gmail.com" method="GET">
    <input type="hidden" name="object" value="Segnalazione problema alla registrazione dell'ordine" />
    <input type="hidden" name="from" value="{email}" />
    <input type="hidden" name="body" value="Da: {user}" id="mailbody" />
    <p class="istruzioni ordineKo" onclick="this.parentNode.submit()">cliccando qui!</p>
  </form>

  <div id="prodotti"></div>

  <a href="confbuy.shtml" id="conflink">Controlla lo stato dell'ordine</a>
  <a href="catalog.shtml" id="catlink">Torna al catalogo</a>
  <a href="landing.shtml" id="lanlink">Torna alla homepage</a>

<!--#include virtual="footer_foowd.shtml" -->
</body>
</html>
